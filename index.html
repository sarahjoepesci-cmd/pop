<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>POP — Simulateur (UMD sans modules)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .card { box-shadow: 0 8px 24px rgba(0,0,0,.08); }
    #err { white-space: pre-wrap; color:#fff; background:#111827; padding:12px; border-radius:12px; display:none; }
  </style>
</head>
<body class="bg-gray-50">
  <div class="max-w-5xl mx-auto p-4">
    <div id="health" class="text-xs text-gray-500">Health: page HTML chargée.</div>
    <div id="err"></div>
    <div id="root"></div>
  </div>

  <!-- UMD libs -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    // Hard error catcher
    window.onerror = function(msg, src, line, col, err){
      const el = document.getElementById('err');
      el.style.display = 'block';
      el.textContent = 'Erreur: ' + msg + '\\n' + (src||'') + ':' + (line||'') + ':' + (col||'') + '\\n' + (err && err.stack ? err.stack : '');
    };
    window.onunhandledrejection = function(e){
      const el = document.getElementById('err');
      el.style.display = 'block';
      el.textContent = 'Unhandled rejection: ' + (e.reason && e.reason.stack ? e.reason.stack : e.reason);
    };

    // Helpers
    function euro(n){ return (n||0).toLocaleString('fr-FR', {style:'currency', currency:'EUR', maximumFractionDigits:0}); }
    function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }
    function seatsFromPopulation(pop){
      if(pop==null || isNaN(pop)) return null;
      const rules = [
        { min:0,max:99,seats:7},{min:100,max:499,seats:11},{min:500,max:1499,seats:15},
        { min:1500,max:2499,seats:19},{min:2500,max:3499,seats:23},{min:3500,max:4999,seats:27},
        { min:5000,max:9999,seats:29},{min:10000,max:19999,seats:33},{min:20000,max:29999,seats:35},
        { min:30000,max:39999,seats:39},{min:40000,max:49999,seats:43},{min:50000,max:59999,seats:45},
        { min:60000,max:79999,seats:49},{min:80000,max:99999,seats:53},{min:100000,max:149999,seats:55},
        { min:150000,max:199999,seats:59},{min:200000,max:249999,seats:61},{min:250000,max:299999,seats:65},
        { min:300000,max:1e12,seats:69},
      ];
      const r = rules.find(r => pop>=r.min && pop<=r.max);
      return r? r.seats : null;
    }
    function isRevenue(m){
      const cat = (m.category||'').toLowerCase();
      return cat.includes('recette') || (+m.base_value||0) < 0;
    }
    function needUnits(scaling){
      return ['per_unit','per_km','per_m2','per_point_lumineux'].indexOf((scaling||'').trim())>=0;
    }
    function computeAmount(m, pop){
      const base = +m.base_value || 0;
      const units = +m.units || 0;
      let val = 0;
      switch((m.scaling||'').trim()){
        case 'per_inhabitant': val = base * (pop||0); break;
        case 'per_unit':
        case 'per_km':
        case 'per_m2':
        case 'per_point_lumineux': val = base * units; break;
        case 'fixed_estimate': val = base; break;
        default: val = +m.montant || 0;
      }
      return val;
    }

    (function(){
      document.getElementById('health').textContent = 'Health: scripts UMD ok, React='+!!window.React+', Papa='+!!window.Papa;

      const e = React.createElement;
      const { useState, useMemo, useEffect } = React;

      function App(){
        const [population, setPopulation] = useState(5000);
        const [eurHab, setEurHab] = useState(1474);
        const [floors, setFloors] = useState([
          { id:'personnel', label:'Personnel', pct:35 },
          { id:'voirie', label:'Voirie', pct:8 },
          { id:'ecoles', label:'Écoles', pct:7 },
          { id:'services', label:'Services obligatoires', pct:5 },
          { id:'energie', label:'Énergie & bâtiments', pct:6 },
          { id:'dette', label:'Dette (annuité)', pct:6 },
        ]);
        const [csvUrl, setCsvUrl] = useState("https://docs.google.com/spreadsheets/d/e/2PACX-1vTJiCwyahttqXaLyaIjNFZo8y4o96DDuRpS4rfHsw6x74gjm7iZtn2xRGn2P7tuHtjjj3633n7dTgzv/pub?output=csv");
        const [rows, setRows] = useState([]);
        const [errCsv, setErrCsv] = useState(null);
        const [loading, setLoading] = useState(false);

        const seats = useMemo(()=> seatsFromPopulation(+population||0), [population]);
        const totalIndicatif = useMemo(()=> (+population||0) * (+eurHab||0), [population, eurHab]);
        const sommePcts = useMemo(()=> floors.reduce((s,f)=> s+(+f.pct||0), 0), [floors]);
        const sommeFloors = useMemo(()=> floors.reduce((s,f)=> s + totalIndicatif * clamp((+f.pct||0)/100,0,1),0), [floors, totalIndicatif]);
        const enveloppeLibre = useMemo(()=> Math.max(0, totalIndicatif - sommeFloors), [totalIndicatif, sommeFloors]);

        const computed = useMemo(()=> rows.map(r=>{
          const R = Object.assign({}, r);
          R.units = needUnits(R.scaling) ? (+R.step_unit||1) : 0;
          R.montant = computeAmount(R, +population||0);
          R.isRevenue = isRevenue(R);
          return R;
        }), [rows, population]);
        const totalDep = useMemo(()=> computed.reduce((s,m)=> s + (m.montant>0? m.montant:0),0), [computed]);
        const totalRec = useMemo(()=> computed.reduce((s,m)=> s + (m.montant<0? -m.montant:0),0), [computed]);
        const totalNet = useMemo(()=> totalDep - totalRec, [totalDep, totalRec]);
        const reliquat = useMemo(()=> Math.max(0, enveloppeLibre - totalNet), [enveloppeLibre, totalNet]);

        function loadCsv(){
          setLoading(true); setErrCsv(null);
          fetch(csvUrl, { cache:'no-store' })
            .then(r => { if(!r.ok) throw new Error('HTTP '+r.status); return r.text(); })
            .then(text => {
              const p = window.Papa.parse(text, { header:true, skipEmptyLines:true });
              if(p.errors && p.errors.length) console.warn('Papa errors', p.errors);
              const data = (p.data||[]).map((r,idx)=> ({
                id: (r.id || ('m_'+idx)).toString().trim(),
                label: (r.label || ('Mesure '+(idx+1))).toString().trim(),
                category: (r.category || '').toString().trim(),
                scaling: (r.scaling || '').toString().trim(),
                unit: (r.unit || '').toString().trim(),
                base_value: +(r.base_value || 0),
                capex_share: +(r.capex_share || 0),
                notes: (r.notes || '').toString(),
                step_unit: +(r.step_unit || 1)
              }));
              setRows(data);
            })
            .catch(err => setErrCsv(err.message||String(err)))
            .finally(()=> setLoading(false));
        }

        useEffect(loadCsv, []);

        function setFloorPct(id, pct){
          setFloors(prev => prev.map(f => f.id===id ? Object.assign({}, f, { pct: +pct }) : f));
        }

        return e('div', { className:'space-y-4' },
          e('div', { className:'card bg-white rounded-2xl p-4' },
            e('div', { className:'text-lg font-semibold mb-2' }, '1) Paramètres de base (UMD diag)'),
            e('div', { className:'grid md:grid-cols-4 gap-3' },
              e('div', null,
                e('div', { className:'text-sm mb-1' }, 'Population'),
                e('input', { className:'input w-full border rounded-lg p-2', type:'number', value: population, onChange: (ev)=> setPopulation(ev.target.value) })
              ),
              e('div', null,
                e('div', { className:'text-sm mb-1' }, 'Hypothèse €/hab'),
                e('input', { className:'input w-full border rounded-lg p-2', type:'number', value: eurHab, onChange: (ev)=> setEurHab(ev.target.value) })
              ),
              e('div', { className:'bg-gray-50 rounded-xl p-3 text-center' },
                e('div', { className:'text-xs text-gray-500' }, 'Budget indicatif'),
                e('div', { className:'text-xl font-bold' }, euro(totalIndicatif))
              ),
              e('div', { className:'bg-gray-50 rounded-xl p-3 text-center' },
                e('div', { className:'text-xs text-gray-500' }, 'Sièges (est.)'),
                e('div', { className:'text-xl font-bold' }, seats==null?'—':String(seats))
              ),
            ),
            e('div', { className:'text-xs text-gray-500 mt-1' }, "NB: moyenne nationale 1 474 €/hab (INSEE 2023).")
          ),

          e('div', { className:'card bg-white rounded-2xl p-4' },
            e('div', { className:'text-lg font-semibold mb-2' }, '2) Impondérables'),
            e('div', { className:'grid md:grid-cols-3 gap-3' },
              floors.map(f => e('div', { key:f.id, className:'bg-gray-50 rounded-xl p-3' },
                e('div', { className:'flex items-center justify-between' },
                  e('div', { className:'font-medium' }, f.label),
                  e('div', null, f.pct, '%')
                ),
                e('input', { type:'range', min:0, max:100, value:f.pct, onChange:(ev)=> setFloorPct(f.id, ev.target.value), className:'w-full my-2' }),
                e('div', { className:'text-sm text-gray-600' }, 'Plancher : ', e('strong', null, euro(totalIndicatif * (f.pct/100))))
              ))
            ),
            e('div', { className:'grid md:grid-cols-3 gap-3 text-center mt-3' },
              e('div', { className:'bg-gray-100 rounded-xl p-3' },
                e('div', { className:'text-xs text-gray-500' }, '% impondérables'),
                e('div', { className:'text-lg font-semibold' }, String(Math.round(sommePcts)), '%')
              ),
              e('div', { className:'bg-gray-100 rounded-xl p-3' },
                e('div', { className:'text-xs text-gray-500' }, 'Somme impondérables'),
                e('div', { className:'text-lg font-semibold' }, euro(sommeFloors))
              ),
              e('div', { className:'bg-gray-100 rounded-xl p-3' },
                e('div', { className:'text-xs text-gray-500' }, 'Enveloppe libre'),
                e('div', { className:'text-lg font-semibold' }, euro(enveloppeLibre))
              ),
            )
          ),

          e('div', { className:'card bg-white rounded-2xl p-4' },
            e('div', { className:'flex items-center justify-between' },
              e('div', { className:'text-lg font-semibold' }, '3) Programme — import automatique (Google Sheets CSV)'),
              e('div', { className:'flex gap-2' },
                e('input', { className:'input border rounded-lg p-2 w-80', value: csvUrl, onChange:(ev)=> setCsvUrl(ev.target.value) }),
                e('button', { className:'btn bg-gray-200', onClick: loadCsv }, 'Recharger')
              )
            ),
            loading ? e('div', { className:'text-sm text-gray-500 mt-2' }, 'Chargement CSV…') : null,
            errCsv ? e('div', { className:'text-sm text-red-600 mt-2' }, 'Erreur CSV: ', errCsv) : null,
            rows.length===0 && !loading && !errCsv ? e('div', { className:'text-sm text-gray-500 mt-2' }, 'Aucune mesure chargée.') : null,
            rows.length>0 ? e('div', { className:'mt-3 text-sm text-gray-700' }, rows.length, ' mesures chargées.') : null,
            rows.length>0 ? e('div', { className:'mt-2 grid gap-2' },
              computed.slice(0,10).map(m => e('div', { key:m.id, className:'border rounded-xl p-2 flex items-center justify-between' },
                e('div', null, m.label, ' ', e('span', { className:'text-xs text-gray-500' }, m.category||'')),
                e('div', null, m.isRevenue ? e('span', { className:'text-green-700 font-semibold' }, '+ ', euro(Math.abs(m.montant))) : e('span', { className:'font-semibold' }, euro(m.montant)))
              ))
            ) : null,
            rows.length>0 ? e('div', { className:'grid md:grid-cols-3 gap-3 text-center mt-3' },
              e('div', { className:'bg-gray-100 rounded-xl p-3' },
                e('div', { className:'text-xs text-gray-500' }, 'Total dépenses'),
                e('div', { className:'text-lg font-semibold' }, euro(totalDep))
              ),
              e('div', { className:'bg-gray-100 rounded-xl p-3' },
                e('div', { className:'text-xs text-gray-500' }, 'Total recettes'),
                e('div', { className:'text-lg font-semibold text-green-700' }, '+ ', euro(totalRec))
              ),
              e('div', { className:'bg-gray-100 rounded-xl p-3' },
                e('div', { className:'text-xs text-gray-500' }, 'Net programme'),
                e('div', { className:'text-lg font-semibold' }, euro(totalNet))
              ),
            ) : null
          ),

          e('div', { className:'text-center text-xs text-gray-500' }, '© POP — UMD minimal pour diagnostic (sans modules / Babel).')
        );
      }

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(React.createElement(App));
    })();
  </script>
</body>
</html>
