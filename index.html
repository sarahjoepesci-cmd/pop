<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Simulateur communal POP — Correctif rendu</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .card { box-shadow: 0 8px 24px rgba(0,0,0,0.08); }
    .chip { border-radius: 9999px; padding: 2px 10px; background: #f3f4f6; font-size: 12px; }
    .dropdown { position: absolute; z-index: 40; width: 100%; background: white; border: 1px solid #e5e7eb; border-radius: 0.75rem; box-shadow: 0 12px 32px rgba(0,0,0,0.08); }
    .dropdown-item { padding: 8px 12px; cursor: pointer; }
    .dropdown-item:hover { background: #f9fafb; }
    .muted { color: #6b7280; }
  </style>
</head>
<body class="bg-gray-50">
  <main id="root" class="p-6 md:p-10 max-w-6xl mx-auto"></main>

  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <script type="text/babel">
    const { useMemo, useState, useEffect, useRef } = React;

    async function fetchOfglBudgets(insee) {
      try {
        const qs = new URLSearchParams({
          dataset: "ofgl-base-communes",
          "refine.codgeo": insee,
          rows: "1",
          sort: "-exer"
        });
        const url = `https://data.ofgl.fr/api/records/1.0/search/?${qs.toString()}`;
        const r = await fetch(url);
        if (!r.ok) throw new Error("Erreur API OFGL");
        const data = await r.json();
        const rec = data.records?.[0]?.fields;
        if (!rec) return null;
        return {
          funcRec: Number(rec.f_rec) || 0,
          funcDep: Number(rec.f_dep) || 0,
          invRec:  Number(rec.i_rec) || 0,
          invDep:  Number(rec.i_dep) || 0,
          year: rec.exer
        };
      } catch (e) { console.warn("Erreur OFGL", e); return null; }
    }

    async function fetchDGF(insee) {
      try {
        const qs = new URLSearchParams({
          dataset: "dgf-communes",
          "refine.codgeo": insee,
          rows: "1",
          sort: "-annee"
        });
        const url = `https://opendata.finances.gouv.fr/api/records/1.0/search/?${qs.toString()}`;
        const r = await fetch(url);
        if (!r.ok) throw new Error("Erreur API DGF");
        const data = await r.json();
        const rec = data.records?.[0]?.fields;
        if (!rec) return null;
        const value = Number(rec.dgf_totale ?? rec.dotation_forfaitaire ?? 0);
        const year  = rec.annee ?? rec.exer ?? null;
        if (!value) return null;
        return { value, year };
      } catch (e) { console.warn("Erreur DGF", e); return null; }
    }

    const seatRules = [
      { min: 0, max: 99, seats: 7 },
      { min: 100, max: 499, seats: 11 },
      { min: 500, max: 1499, seats: 15 },
      { min: 1500, max: 2499, seats: 19 },
      { min: 2500, max: 3499, seats: 23 },
      { min: 3500, max: 4999, seats: 27 },
      { min: 5000, max: 9999, seats: 29 },
      { min: 10000, max: 19999, seats: 33 },
      { min: 20000, max: 29999, seats: 35 },
      { min: 30000, max: 39999, seats: 39 },
      { min: 40000, max: 49999, seats: 43 },
      { min: 50000, max: 59999, seats: 45 },
      { min: 60000, max: 79999, seats: 49 },
      { min: 80000, max: 99999, seats: 53 },
      { min: 100000, max: 149999, seats: 55 },
      { min: 150000, max: 199999, seats: 59 },
      { min: 200000, max: 249999, seats: 61 },
      { min: 250000, max: 299999, seats: 65 },
      { min: 300000, max: Infinity, seats: 69 },
    ];

    function seatsFromPopulation(pop) {
      if (pop == null || isNaN(pop)) return null;
      const r = seatRules.find((r) => pop >= r.min && pop <= r.max);
      return r ? r.seats : null;
    }
    function modeScrutin(pop) {
      if (pop == null || isNaN(pop)) return "—";
      return pop >= 1000 ? "Scrutin de liste paritaire (≥ 1000 hab)" : "Scrutin majoritaire plurinominal (panachage)";
    }

    const MEASURES = [
      { id: "proprete_tri", label: "Propreté — Bacs + tri collectif", unitLabel: "bacs", defaultUnits: 60, defaultUnitCost: 320, capexShare: 0.5, type: "expense" },
      { id: "voirie_velo", label: "Mobilité — Marquage pistes cyclables", unitLabel: "km", defaultUnits: 5, defaultUnitCost: 40000, capexShare: 0.8, type: "expense" },
      { id: "abris_velo", label: "Mobilité — Abris vélo sécurisés", unitLabel: "abris", defaultUnits: 8, defaultUnitCost: 9500, capexShare: 0.85, type: "expense" },
      { id: "radars_sonores", label: "Environnement — Radars sonores", unitLabel: "radars", defaultUnits: 3, defaultUnitCost: 18000, capexShare: 0.8, type: "expense" },
      { id: "toits_vegetalises", label: "Espaces verts — Toits végétalisés", unitLabel: "m²", defaultUnits: 2500, defaultUnitCost: 75, capexShare: 1.0, type: "expense" },
      { id: "gymnases_adultes", label: "Sport — Gymnases pour adultes (équipement)", unitLabel: "sites", defaultUnits: 2, defaultUnitCost: 80000, capexShare: 0.85, type: "expense" },
      { id: "carte_culture", label: "Culture — Carte culture locale", unitLabel: "€/hab/an", defaultUnits: 10, defaultUnitCost: 1, capexShare: 0.0, type: "expense" },
      { id: "taxe_residences_secondaires", label: "Recette — Surtaxe résidences secondaires", unitLabel: "k€ estimés/an", defaultUnits: 50, defaultUnitCost: 1000, capexShare: 0.0, type: "revenue" },
    ];

    function euro(n) { return (n ?? 0).toLocaleString("fr-FR", { style: "currency", currency: "EUR", maximumFractionDigits: 0 }); }
    function useDebouncedValue(value, delay=300) { const [v, setV] = React.useState(value); React.useEffect(()=>{const t=setTimeout(()=>setV(value),delay);return()=>clearTimeout(t);},[value,delay]); return v; }

    function CommuneAutocomplete({ value, onSelect, onPopulation }) {
      const [query, setQuery] = useState(value || ""); const [list, setList] = useState([]); const [open, setOpen] = useState(false);
      const debounced = useDebouncedValue(query, 300); const ref = useRef(null);
      useEffect(()=>{ if(!debounced||debounced.length<2){setList([]);return;} const c=new AbortController();
        fetch(`https://geo.api.gouv.fr/communes?nom=${encodeURIComponent(debounced)}&fields=nom,code,codesPostaux,centre,population&boost=population&limit=10`,{signal:c.signal})
         .then(r=>r.json()).then(d=>{setList(Array.isArray(d)?d:[]);setOpen(true);}).catch(()=>{});
        return ()=>c.abort(); },[debounced]);
      useEffect(()=>{function onClick(e){ if(ref.current && !ref.current.contains(e.target)) setOpen(false);} document.addEventListener("click",onClick); return()=>document.removeEventListener("click",onClick);},[]);
      return (<div className="relative" ref={ref}>
        <input className="w-full border rounded-xl px-3 py-2" placeholder="ex. Saint-André-les-Alpes" value={query} onChange={(e)=>setQuery(e.target.value)} onFocus={()=>setOpen(true)} />
        {open && list.length>0 && (<div className="dropdown mt-1">{list.map(c=>(<div key={c.code} className="dropdown-item"
          onClick={()=>{setQuery(c.nom);setOpen(false);onSelect&&onSelect(c);onPopulation&&onPopulation(c.population||null);}}>
            <div className="font-medium">{c.nom}</div><div className="text-xs muted">INSEE {c.code} • Pop. {c.population?.toLocaleString("fr-FR")||"?"}</div></div>))}</div>)}
      </div>);
    }

    function App() {
      const [commune, setCommune] = useState({ nom: "", insee: "", population: null });
      const [population, setPopulation] = useState(null);
      const [baseBudgetFuncDep, setBaseBudgetFuncDep] = useState(2000000);
      const [baseBudgetFuncRec, setBaseBudgetFuncRec] = useState(2100000);
      const [baseBudgetInvDep, setBaseBudgetInvDep] = useState(1000000);
      const [baseBudgetInvRec, setBaseBudgetInvRec] = useState(900000);
      const [dgf, setDgf] = useState(300000);
      const [autoYear, setAutoYear] = useState(null);
      const [autoDgfYear, setAutoDgfYear] = useState(null);
      const [basket, setBasket] = useState(MEASURES.map(m=>({id:m.id,units:m.defaultUnits,unitCost:m.defaultUnitCost})));

      const popRef = useMemo(()=> (population ?? commune.population ?? null), [population, commune]);
      const seats = useMemo(()=> seatsFromPopulation(popRef), [popRef]);
      const scrutin = useMemo(()=> modeScrutin(popRef), [popRef]);

      const totals = useMemo(()=>{ let capex=0, opex=0, newRecettes=0;
        for(const item of basket){
          const m = MEASURES.find(x=>x.id===item.id); if(!m) continue;
          let cost=(item.units||0)*(item.unitCost||0);
          if(m.id==="carte_culture"){ cost = (item.units||0) * (popRef||0); }
          if(m.type==="revenue"){ newRecettes += cost; } else { capex += cost*m.capexShare; opex += cost*(1-m.capexShare); }
        } return { capex, opex, total: capex+opex, recettes: newRecettes }; }, [basket, popRef]);

      const epargneBruteAvant = baseBudgetFuncRec - baseBudgetFuncDep;
      const epargneBruteApres = (baseBudgetFuncRec + totals.recettes) - (baseBudgetFuncDep + totals.opex);

      const dispoAvant = Math.max(0, (baseBudgetFuncRec - baseBudgetFuncDep))
                       + Math.max(0, (baseBudgetInvRec + dgf) - baseBudgetInvDep);
      const dispoApres = Math.max(0, (baseBudgetFuncRec + totals.recettes) - (baseBudgetFuncDep + totals.opex))
                       + Math.max(0, (baseBudgetInvRec + dgf) - (baseBudgetInvDep + totals.capex));

      function downloadPDF(){ const el=document.getElementById("pdf-area"); const opt={margin:8,filename:`Dossier_POP_${(commune.nom||"commune").replace(/\s+/g,"_")}.pdf`,image:{type:"jpeg",quality:0.98},html2canvas:{scale:2,useCORS:true},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"}}; html2pdf().set(opt).from(el).save(); }
      function downloadJson(){ const payload={ commune:{ nom:commune.nom||"", insee:commune.insee||"", population_reference:popRef, mode_scrutin:scrutin, sieges:seats, dgf_estimee:dgf }, budget_base:{ fonctionnement:{ depenses:baseBudgetFuncDep, recettes:baseBudgetFuncRec }, investissement:{ depenses:baseBudgetInvDep, recettes:baseBudgetInvRec }, epargne_brute:epargneBruteAvant, budget_disponible_avant:dispoAvant, budget_disponible_apres:dispoApres }, programme:basket, resultats:{ capex:totals.capex, opex:totals.opex, recettes_nouvelles:totals.recettes, epargne_brute_apres:epargneBruteApres } }; const blob=new Blob([JSON.stringify(payload,null,2)],{type:"application/json"}); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download=`simulation_POP_${(commune.nom||"commune").replace(/\s+/g,"_")}.json`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }

      async function handleSelectCommune(c){
        setCommune({ nom: c.nom, insee: c.code, population: c.population || null });
        setPopulation(c.population || null);

        const b = await fetchOfglBudgets(c.code);
        if (b) {
          setBaseBudgetFuncRec(b.funcRec);
          setBaseBudgetFuncDep(b.funcDep);
          setBaseBudgetInvRec(b.invRec);
          setBaseBudgetInvDep(b.invDep);
          setAutoYear(b.year);
        } else { setAutoYear(null); }

        const d = await fetchDGF(c.code);
        if (d && typeof d.value === "number") {
          setDgf(d.value);
          setAutoDgfYear(d.year || null);
        } else { setAutoDgfYear(null); }
      }

      return (<div className="space-y-6">
        <div className="flex items-center justify-between flex-wrap gap-3">
          <h1 className="text-2xl md:text-3xl font-bold">Simulateur communal POP</h1>
          <div className="flex gap-2">
            <button onClick={downloadJson} className="px-4 py-2 rounded-2xl bg-black text-white">Exporter JSON</button>
            <button onClick={downloadPDF} className="px-4 py-2 rounded-2xl bg-pink-600 text-white">Exporter PDF</button>
          </div>
        </div>

        <div id="pdf-area" className="space-y-6">
          <section className="card bg-white rounded-2xl p-6">
            <div className="flex items-center justify-between">
              <div>
                <div className="text-xs uppercase muted">Dossier candidat — POP</div>
                <div className="text-2xl font-bold mt-1">{commune.nom || "Votre commune"}</div>
                <div className="mt-1 chip inline-block">INSEE {commune.insee || "—"}</div>
              </div>
              <div className="text-right">
                <div className="chip">Population: {popRef?.toLocaleString("fr-FR") || "—"}</div>
                <div className="chip mt-2">Sièges: {seats ?? "—"}</div>
              </div>
            </div>
            <div className="mt-4 text-sm muted">{scrutin}</div>
          </section>

          <section className="card bg-white rounded-2xl p-6">
            <h2 className="text-xl font-semibold mb-4">1) Commune</h2>
            <div className="grid md:grid-cols-4 gap-4 items-start">
              <div className="md:col-span-2 relative">
                <label className="block text-sm mb-1">Nom de la commune (auto-complétion)</label>
                <CommuneAutocomplete value={commune.nom} onSelect={handleSelectCommune} onPopulation={(p)=>setPopulation(p)} />
              </div>
              <div>
                <label className="block text-sm mb-1">Population (si besoin, éditable)</label>
                <input type="number" className="w-full border rounded-xl px-3 py-2" placeholder="ex. 3450" value={popRef ?? ""} onChange={(e)=>setPopulation(e.target.value?Number(e.target.value):null)} min={0} />
              </div>
              <div className="bg-gray-100 rounded-xl p-3 text-center">
                <div className="text-xs uppercase muted">Sièges estimés</div>
                <div className="text-2xl font-bold">{seats ?? "—"}</div>
                <div className="text-xs muted">{scrutin}</div>
              </div>
            </div>
            <div className="mt-2 text-xs muted">
              {autoYear ? <>Budgets préremplis (OFGL {autoYear})</> : <>Saisissez ou sélectionnez une commune pour préremplir</>}
              {autoDgfYear ? <> • DGF {autoDgfYear}</> : null}
            </div>
          </section>

          <section className="card bg-white rounded-2xl p-6">
            <div className="flex items-center justify-between mb-2">
              <h2 className="text-xl font-semibold">2) Budget de base</h2>
              <div className="text-xs muted">{autoYear ? <>OFGL {autoYear}</> : <>—</>}{autoDgfYear ? <> • DGF {autoDgfYear}</> : null}</div>
            </div>
            <div className="grid md:grid-cols-2 gap-4">
              <div className="bg-gray-50 rounded-xl p-3">
                <div className="font-medium mb-2">Fonctionnement</div>
                <label className="text-sm">Recettes</label>
                <input type="number" className="w-full border rounded-xl px-3 py-2 mb-2" value={baseBudgetFuncRec} onChange={(e)=>setBaseBudgetFuncRec(Number(e.target.value))} />
                <label className="text-sm">Dépenses</label>
                <input type="number" className="w-full border rounded-xl px-3 py-2" value={baseBudgetFuncDep} onChange={(e)=>setBaseBudgetFuncDep(Number(e.target.value))} />
              </div>
              <div className="bg-gray-50 rounded-xl p-3">
                <div className="font-medium mb-2">Investissement</div>
                <label className="text-sm">Recettes (hors DGF)</label>
                <input type="number" className="w-full border rounded-xl px-3 py-2 mb-2" value={baseBudgetInvRec} onChange={(e)=>setBaseBudgetInvRec(Number(e.target.value))} />
                <label className="text-sm">Dépenses</label>
                <input type="number" className="w-full border rounded-xl px-3 py-2" value={baseBudgetInvDep} onChange={(e)=>setBaseBudgetInvDep(Number(e.target.value))} />
              </div>
            </div>

            <div className="mt-4 grid md:grid-cols-7 gap-4 text-center">
              <div className="bg-gray-100 rounded-xl p-3"><div className="text-xs muted">Épargne brute AVANT</div><div className={(epargneBruteAvant)<0? "text-lg font-semibold text-red-600":"text-lg font-semibold"}>{euro(epargneBruteAvant)}</div></div>
              <div className="bg-gray-100 rounded-xl p-3"><div className="text-xs muted">CAPEX programme</div><div className="text-lg font-semibold">{euro(totals.capex)}</div></div>
              <div className="bg-gray-100 rounded-xl p-3"><div className="text-xs muted">OPEX programme</div><div className="text-lg font-semibold">{euro(totals.opex)}</div></div>
              <div className="bg-gray-100 rounded-xl p-3"><div className="text-xs muted">Nouvelles recettes</div><div className="text-lg font-semibold">{euro(totals.recettes)}</div></div>
              <div className="bg-gray-100 rounded-xl p-3"><div className="text-xs muted">Épargne APRÈS</div><div className={(epargneBruteApres)<0? "text-lg font-semibold text-red-600":"text-lg font-semibold"}>{euro(epargneBruteApres)}</div></div>
              <div className="bg-gray-100 rounded-xl p-3"><div className="text-xs muted">Budget disponible AVANT</div><div className="text-lg font-semibold">{euro(dispoAvant)}</div><div className="text-[11px] muted">max(Épargne F,0)+max(Solde I,0)</div></div>
              <div className="bg-gray-100 rounded-xl p-3"><div className="text-xs muted">Budget disponible APRÈS</div><div className="text-lg font-semibold">{euro(dispoApres)}</div><div className="text-[11px] muted">inclut recettes & coûts du programme</div></div>
            </div>
          </section>

          <section className="card bg-white rounded-2xl p-6">
            <h2 className="text-xl font-semibold mb-4">3) Mesures POP</h2>
            <div className="grid md:grid-cols-2 gap-4">
              {MEASURES.map(m=>{ const sel = basket.find(b=>b.id===m.id); return (
                <div key={m.id} className="border rounded-2xl p-4">
                  <div className="flex items-center justify-between mb-2"><div className="font-medium">{m.label}</div><span className="chip">{m.type==="revenue"?"Recette":"Dépense"}</span></div>
                  <div className="grid grid-cols-2 gap-3">
                    <div><label className="block text-sm mb-1">{m.unitLabel}</label><input type="number" className="w-full border rounded-xl px-3 py-2" value={sel.units} onChange={(e)=>setBasket(prev=>prev.map(b=>b.id===m.id?{...b,units:Number(e.target.value)}:b))} /></div>
                    <div><label className="block text-sm mb-1">Coût unitaire (€)</label><input type="number" className="w-full border rounded-xl px-3 py-2" value={sel.unitCost} onChange={(e)=>setBasket(prev=>prev.map(b=>b.id===m.id?{...b,unitCost:Number(e.target.value)}:b))} /></div>
                  </div>
                  {m.id==="carte_culture" && <div className="mt-2 text-xs muted">Coût = (€/hab/an) × population.</div>}
                  <div className="mt-2 text-xs muted">CAPEX {Math.round(m.capexShare*100)}% / OPEX {Math.round((1-m.capexShare)*100)}%</div>
                </div>
              );})}
            </div>
          </section>

          <section className="card bg-white rounded-2xl p-6">
            <h2 className="text-xl font-semibold mb-2">Règles du jeu (rappel)</h2>
            <ul className="list-disc pl-6 text-sm muted space-y-1">
              <li><strong>&lt; 1 000 hab</strong> : scrutin majoritaire plurinominal (panachage).</li>
              <li><strong>≥ 1 000 hab</strong> : scrutin de liste à deux tours, listes paritaires, prime majoritaire.</li>
              <li>Nombre de conseillers municipaux : tranches de population.</li>
              <li>Prototype — vérifiez les textes officiels 2026.</li>
            </ul>
          </section>

          <section className="text-center text-xs muted">© POP — Prototype statique. Valeurs indicatives. Sources: OFGL, opendata.finances.gouv.fr</section>
        </div>
      </div>);
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
