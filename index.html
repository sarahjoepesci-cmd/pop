<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Simulateur communal POP — Standalone+ (auto-complétion & PDF)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .pop-gradient { background: linear-gradient(90deg, #ff2e63 0%, #08d9d6 50%, #f9ed69 100%); }
    .card { box-shadow: 0 8px 24px rgba(0,0,0,0.08); }
    .chip { border-radius: 9999px; padding: 2px 10px; background: #f3f4f6; font-size: 12px; }
    .dropdown { position: absolute; z-index: 40; width: 100%; background: white; border: 1px solid #e5e7eb; border-radius: 0.75rem; box-shadow: 0 12px 32px rgba(0,0,0,0.08); }
    .dropdown-item { padding: 8px 12px; cursor: pointer; }
    .dropdown-item:hover { background: #f9fafb; }
  </style>
</head>
<body class="bg-gray-50">
  <div class="pop-gradient h-2 w-full"></div>
  <main id="root" class="p-6 md:p-10"></main>

  <!-- React + Babel -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- html2pdf for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <script type="text/babel">
    const { useMemo, useState, useEffect, useRef } = React;

    // Mapping sièges officiel (à vérifier et maintenir)
    const seatRules = [
      { min: 0, max: 99, seats: 7 },
      { min: 100, max: 499, seats: 11 },
      { min: 500, max: 1499, seats: 15 },
      { min: 1500, max: 2499, seats: 19 },
      { min: 2500, max: 3499, seats: 23 },
      { min: 3500, max: 4999, seats: 27 },
      { min: 5000, max: 9999, seats: 29 },
      { min: 10000, max: 19999, seats: 33 },
      { min: 20000, max: 29999, seats: 35 },
      { min: 30000, max: 39999, seats: 39 },
      { min: 40000, max: 49999, seats: 43 },
      { min: 50000, max: 59999, seats: 45 },
      { min: 60000, max: 79999, seats: 49 },
      { min: 80000, max: 99999, seats: 53 },
      { min: 100000, max: Infinity, seats: 55 },
    ];

    function seatsFromPopulation(pop) {
      if (pop == null || isNaN(pop)) return null;
      const r = seatRules.find((r) => pop >= r.min && pop <= r.max);
      return r ? r.seats : null;
    }

    function modeScrutin(pop) {
      if (pop == null || isNaN(pop)) return "—";
      // Règle actuelle : <1000 = majoritaire plurinominal (panachage), >=1000 = liste paritaire
      return pop >= 1000 ? "Scrutin de liste paritaire (>= 1000 hab)" : "Scrutin majoritaire plurinominal (panachage)";
    }

    // Mesures POP — 8 mesures (7 dépenses + 1 recette)
    const MEASURES = [
      { id: "proprete_tri", label: "Propreté — Bacs + tri collectif", unitLabel: "bacs", defaultUnits: 60, defaultUnitCost: 320, capexShare: 0.5, type: "expense" },
      { id: "voirie_velo", label: "Mobilité — Marquage pistes cyclables", unitLabel: "km", defaultUnits: 5, defaultUnitCost: 40000, capexShare: 0.8, type: "expense" },
      { id: "abris_velo", label: "Mobilité — Abris vélo sécurisés", unitLabel: "abris", defaultUnits: 8, defaultUnitCost: 9500, capexShare: 0.85, type: "expense" },
      { id: "radars_sonores", label: "Environnement — Radars sonores", unitLabel: "radars", defaultUnits: 3, defaultUnitCost: 18000, capexShare: 0.8, type: "expense" },
      { id: "toits_vegetalises", label: "Espaces verts — Toits végétalisés", unitLabel: "m²", defaultUnits: 2500, defaultUnitCost: 75, capexShare: 1.0, type: "expense" },
      { id: "gymnases_adultes", label: "Sport — Gymnases pour adultes (équipement)", unitLabel: "sites", defaultUnits: 2, defaultUnitCost: 80000, capexShare: 0.85, type: "expense" },
      { id: "carte_culture", label: "Culture — Carte culture locale", unitLabel: "€/hab/an", defaultUnits: 10, defaultUnitCost: 1, capexShare: 0.0, type: "expense" }, // opex pur: montant * population
      { id: "taxe_residences_secondaires", label: "Recette — Surtaxe résidences secondaires", unitLabel: "k€ estimés/an", defaultUnits: 50, defaultUnitCost: 1000, capexShare: 0.0, type: "revenue" }, // revenue: defaultUnits * 1000 €
    ];

    function euro(n) {
      return (n ?? 0).toLocaleString("fr-FR", { style: "currency", currency: "EUR", maximumFractionDigits: 0 });
    }

    function useDebouncedValue(value, delay=300) {
      const [v, setV] = useState(value);
      useEffect(() => {
        const t = setTimeout(() => setV(value), delay);
        return () => clearTimeout(t);
      }, [value, delay]);
      return v;
    }

    function CommuneAutocomplete({ value, onSelect, onPopulation }) {
      const [query, setQuery] = useState(value || "");
      const [list, setList] = useState([]);
      const [open, setOpen] = useState(false);
      const debounced = useDebouncedValue(query, 300);
      const ref = useRef(null);

      useEffect(() => {
        if (!debounced || debounced.length < 2) { setList([]); return; }
        const controller = new AbortController();
        fetch(`https://geo.api.gouv.fr/communes?nom=${encodeURIComponent(debounced)}&fields=nom,code,codesPostaux,centre,population&boost=population&limit=10`, { signal: controller.signal })
          .then(r => r.json()).then(data => {
            setList(Array.isArray(data) ? data : []);
            setOpen(true);
          }).catch(() => {});
        return () => controller.abort();
      }, [debounced]);

      useEffect(() => {
        function onClick(e) {
          if (ref.current && !ref.current.contains(e.target)) setOpen(false);
        }
        document.addEventListener("click", onClick);
        return () => document.removeEventListener("click", onClick);
      }, []);

      return (
        <div className="relative" ref={ref}>
          <input className="w-full border rounded-xl px-3 py-2" placeholder="ex. Saint-André-les-Alpes"
                 value={query} onChange={(e) => setQuery(e.target.value)} onFocus={() => setOpen(true)} />
          {open && list.length > 0 && (
            <div className="dropdown mt-1">
              {list.map((c) => (
                <div key={c.code} className="dropdown-item"
                     onClick={() => { setQuery(c.nom); setOpen(false); onSelect && onSelect(c); onPopulation && onPopulation(c.population || null); }}>
                  <div className="font-medium">{c.nom}</div>
                  <div className="text-xs text-gray-500">INSEE {c.code} • Pop. {c.population?.toLocaleString("fr-FR") || "?"}</div>
                </div>
              ))}
            </div>
          )}
        </div>
      );
    }

    function App() {
      const [commune, setCommune] = useState({ nom: "", insee: "", population: null });
      const [population, setPopulation] = useState(null);

      const [baseBudgetFuncDep, setBaseBudgetFuncDep] = useState(2000000);
      const [baseBudgetFuncRec, setBaseBudgetFuncRec] = useState(2100000);
      const [baseBudgetInvDep, setBaseBudgetInvDep] = useState(1000000);
      const [baseBudgetInvRec, setBaseBudgetInvRec] = useState(900000);
      const [dgf, setDgf] = useState(300000);

      const [basket, setBasket] = useState(
        MEASURES.map((m) => ({ id: m.id, units: m.defaultUnits, unitCost: m.defaultUnitCost }))
      );

      const popRef = useMemo(() => (population ?? commune.population ?? null), [population, commune]);
      const seats = useMemo(() => seatsFromPopulation(popRef), [popRef]);
      const scrutin = useMemo(() => modeScrutin(popRef), [popRef]);

      const totals = useMemo(() => {
        let capex = 0, opex = 0, newRecettes = 0;
        for (const item of basket) {
          const meta = MEASURES.find((m) => m.id === item.id);
          if (!meta) continue;
          let cost = (item.units || 0) * (item.unitCost || 0);
          if (meta.id === "carte_culture") {
            // coût = (€/hab/an) * population
            cost = (item.units || 0) * (popRef || 0);
          }
          if (meta.type === "revenue") {
            newRecettes += cost; // on considère en €/an
          } else {
            capex += cost * meta.capexShare;
            opex += cost * (1 - meta.capexShare);
          }
        }
        return { capex, opex, total: capex + opex, recettes: newRecettes };
      }, [basket, popRef]);

      const afterFuncDep = baseBudgetFuncDep + totals.opex;
      const afterFuncRec = baseBudgetFuncRec + totals.recettes;
      const afterInvDep = baseBudgetInvDep + totals.capex;
      const afterInvRec = baseBudgetInvRec + dgf;

      const epargneBruteAvant = baseBudgetFuncRec - baseBudgetFuncDep;
      const epargneBruteApres = afterFuncRec - afterFuncDep;

      function updateBasket(id, field, value) {
        setBasket((prev) => prev.map((b) => (b.id === id ? { ...b, [field]: value } : b)));
      }

      function downloadPDF() {
        const element = document.getElementById("pdf-area");
        const opt = { margin: 8, filename: `Dossier_POP_${(commune.nom || "commune").replace(/\\s+/g, "_")}.pdf`, image: { type: "jpeg", quality: 0.98 }, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: "mm", format: "a4", orientation: "portrait" } };
        html2pdf().set(opt).from(element).save();
      }

      function downloadJson() {
        const payload = {
          commune: { nom: commune.nom || "", insee: commune.insee || "", population_reference: popRef, mode_scrutin: scrutin, sieges: seats, dgf_estimee: dgf },
          budget_base: { fonctionnement: { depenses: baseBudgetFuncDep, recettes: baseBudgetFuncRec }, investissement: { depenses: baseBudgetInvDep, recettes: baseBudgetInvRec }, epargne_brute: epargneBruteAvant },
          programme: basket,
          resultats: { capex: totals.capex, opex: totals.opex, recettes_nouvelles: totals.recettes, epargne_brute_apres: epargneBruteApres },
        };
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `simulation_POP_${(commune.nom || "commune").replace(/\\s+/g, "_")}.json`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }

      return (
        <div className="max-w-6xl mx-auto space-y-6">
          <div className="flex items-center justify-between flex-wrap gap-3">
            <h1 className="text-2xl md:text-3xl font-bold">Simulateur communal POP</h1>
            <div className="flex gap-2">
              <button onClick={downloadJson} className="px-4 py-2 rounded-2xl bg-black text-white">Exporter JSON</button>
              <button onClick={downloadPDF} className="px-4 py-2 rounded-2xl bg-pink-600 text-white">Exporter PDF</button>
            </div>
          </div>

          <div id="pdf-area" className="space-y-6">
            {/* Couverture PDF */}
            <section className="card bg-white rounded-2xl p-6">
              <div className="flex items-center justify-between">
                <div>
                  <div className="text-xs uppercase tracking-wide text-gray-500">Dossier candidat — POP</div>
                  <div className="text-2xl font-bold mt-1">{commune.nom || "Votre commune"}</div>
                  <div className="mt-1 chip inline-block">INSEE {commune.insee || "—"}</div>
                </div>
                <div className="text-right">
                  <div className="chip">Population: {popRef?.toLocaleString("fr-FR") || "—"}</div>
                  <div className="chip mt-2">Sièges: {seats ?? "—"}</div>
                </div>
              </div>
              <div className="mt-4 text-sm text-gray-600">{scrutin}</div>
            </section>

            {/* 1) Commune */}
            <section className="card bg-white rounded-2xl p-6">
              <h2 className="text-xl font-semibold mb-4">1) Commune</h2>
              <div className="grid md:grid-cols-4 gap-4 items-start">
                <div className="md:col-span-2 relative">
                  <label className="block text-sm mb-1">Nom de la commune (auto-complétion)</label>
                  <CommuneAutocomplete
                    value={commune.nom}
                    onSelect={(c) => setCommune({ nom: c.nom, insee: c.code, population: c.population || null })}
                    onPopulation={(p) => setPopulation(p)}
                  />
                </div>
                <div>
                  <label className="block text-sm mb-1">Population (si besoin, éditable)</label>
                  <input type="number" className="w-full border rounded-xl px-3 py-2" placeholder="ex. 3450"
                         value={popRef ?? ""} onChange={(e) => setPopulation(e.target.value ? Number(e.target.value) : null)} min={0} />
                </div>
                <div className="bg-gray-100 rounded-xl p-3 text-center">
                  <div className="text-xs uppercase tracking-wide text-gray-500">Sièges estimés</div>
                  <div className="text-2xl font-bold">{seats ?? "—"}</div>
                  <div className="text-xs text-gray-600">{scrutin}</div>
                </div>
              </div>
            </section>

            {/* 2) Budget */}
            <section className="card bg-white rounded-2xl p-6">
              <h2 className="text-xl font-semibold mb-4">2) Budget de base</h2>
              <div className="grid md:grid-cols-2 gap-4">
                <div className="bg-gray-50 rounded-xl p-3">
                  <div className="font-medium mb-2">Fonctionnement</div>
                  <label className="text-sm">Recettes</label>
                  <input type="number" className="w-full border rounded-xl px-3 py-2 mb-2" value={baseBudgetFuncRec}
                         onChange={(e) => setBaseBudgetFuncRec(Number(e.target.value))} />
                  <label className="text-sm">Dépenses</label>
                  <input type="number" className="w-full border rounded-xl px-3 py-2" value={baseBudgetFuncDep}
                         onChange={(e) => setBaseBudgetFuncDep(Number(e.target.value))} />
                </div>
                <div className="bg-gray-50 rounded-xl p-3">
                  <div className="font-medium mb-2">Investissement</div>
                  <label className="text-sm">Recettes (hors DGF)</label>
                  <input type="number" className="w-full border rounded-xl px-3 py-2 mb-2" value={baseBudgetInvRec}
                         onChange={(e) => setBaseBudgetInvRec(Number(e.target.value))} />
                  <label className="text-sm">Dépenses</label>
                  <input type="number" className="w-full border rounded-xl px-3 py-2" value={baseBudgetInvDep}
                         onChange={(e) => setBaseBudgetInvDep(Number(e.target.value))} />
                </div>
              </div>
              <div className="mt-4 grid md:grid-cols-5 gap-4 text-center">
                <div className="bg-gray-100 rounded-xl p-3">
                  <div className="text-xs text-gray-600">Épargne brute AVANT</div>
                  <div className={\`text-lg font-semibold \${(baseBudgetFuncRec - baseBudgetFuncDep) < 0 ? "text-red-600" : ""}\`}>
                    {euro(baseBudgetFuncRec - baseBudgetFuncDep)}
                  </div>
                </div>
                <div className="bg-gray-100 rounded-xl p-3"><div className="text-xs text-gray-600">CAPEX programme</div><div className="text-lg font-semibold">{euro(totals.capex)}</div></div>
                <div className="bg-gray-100 rounded-xl p-3"><div className="text-xs text-gray-600">OPEX programme</div><div className="text-lg font-semibold">{euro(totals.opex)}</div></div>
                <div className="bg-gray-100 rounded-xl p-3"><div className="text-xs text-gray-600">Nouvelles recettes</div><div className="text-lg font-semibold">{euro(totals.recettes)}</div></div>
                <div className="bg-gray-100 rounded-xl p-3">
                  <div className="text-xs text-gray-600">Épargne APRÈS</div>
                  <div className={\`text-lg font-semibold \${(afterFuncRec - afterFuncDep) < 0 ? "text-red-600" : ""}\`}>
                    {euro(afterFuncRec - afterFuncDep)}
                  </div>
                </div>
              </div>
            </section>

            {/* 3) Mesures */}
            <section className="card bg-white rounded-2xl p-6">
              <h2 className="text-xl font-semibold mb-4">3) Mesures POP</h2>
              <div className="grid md:grid-cols-2 gap-4">
                {MEASURES.map((m) => {
                  const sel = basket.find((b) => b.id === m.id);
                  return (
                    <div key={m.id} className="border rounded-2xl p-4">
                      <div className="flex items-center justify-between mb-2">
                        <div className="font-medium">{m.label}</div>
                        <span className="chip">{m.type === "revenue" ? "Recette" : "Dépense"}</span>
                      </div>
                      <div className="grid grid-cols-2 gap-3">
                        <div>
                          <label className="block text-sm mb-1">{m.unitLabel}</label>
                          <input type="number" className="w-full border rounded-xl px-3 py-2" value={sel.units}
                                 onChange={(e) => updateBasket(m.id, "units", Number(e.target.value))} />
                        </div>
                        <div>
                          <label className="block text-sm mb-1">Coût unitaire (€)</label>
                          <input type="number" className="w-full border rounded-xl px-3 py-2" value={sel.unitCost}
                                 onChange={(e) => updateBasket(m.id, "unitCost", Number(e.target.value))} />
                        </div>
                      </div>
                      {m.id === "carte_culture" && <div className="mt-2 text-xs text-gray-500">Le coût = (€/hab/an) × population de la commune.</div>}
                      {m.type === "expense" && <div className="mt-2 text-sm text-gray-600">CAPEX {Math.round(m.capexShare * 100)}% / OPEX {Math.round((1 - m.capexShare) * 100)}%</div>}
                    </div>
                  );
                })}
              </div>
            </section>

            {/* 4) Règles du jeu */}
            <section className="card bg-white rounded-2xl p-6">
              <h2 className="text-xl font-semibold mb-2">Règles du jeu (rappel)</h2>
              <ul className="list-disc pl-6 text-sm text-gray-700 space-y-1">
                <li><strong>&lt; 1 000 hab</strong> : scrutin majoritaire plurinominal (panachage, bulletin ouvert).</li>
                <li><strong>≥ 1 000 hab</strong> : scrutin de liste à deux tours, listes paritaires (alternance H/F), prime majoritaire.</li>
                <li>Nombre de conseillers municipaux : déterminé par tranches de population (cf. cartouche “Sièges estimés”).</li>
                <li>Ce simulateur est un prototype ; vérifiez les textes officiels à jour pour 2026.</li>
              </ul>
            </section>

            <section className="text-center text-xs text-gray-500">
              © POP — Prototype enrichi (auto-complétion, recettes, PDF). Valeurs indicatives.
            </section>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
