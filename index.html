<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Simulateur POP — Budget simple par habitant</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .card { box-shadow: 0 8px 24px rgba(0,0,0,0.08); }
    .chip { border-radius: 9999px; padding: 2px 10px; background: #f3f4f6; font-size: 12px; }
    .dropdown { position: absolute; z-index: 40; width: 100%; background: white; border: 1px solid #e5e7eb; border-radius: 0.75rem; box-shadow: 0 12px 32px rgba(0,0,0,0.08); }
    .dropdown-item { padding: 8px 12px; cursor: pointer; }
    .dropdown-item:hover { background: #f9fafb; }
    .muted { color: #6b7280; }
    .input { width: 100%; border: 1px solid #e5e7eb; border-radius: 0.75rem; padding: 0.5rem 0.75rem; }
    .btn { border-radius: 1rem; padding: 0.5rem 0.9rem; }
  </style>
</head>
<body class="bg-gray-50">
  <main id="root" class="p-6 md:p-10 max-w-6xl mx-auto"></main>

  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <script type="text/babel">
    const { useMemo, useState, useEffect, useRef } = React;

    function euro(n){ return (n ?? 0).toLocaleString('fr-FR', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }); }
    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
    function useDebouncedValue(value, delay=300) { const [v, setV]=React.useState(value); React.useEffect(()=>{const t=setTimeout(()=>setV(value),delay); return ()=>clearTimeout(t);},[value,delay]); return v; }

    function CommuneAutocomplete({ value, onSelect, onPopulation }){
      const [query, setQuery] = useState(value || "");
      const [list, setList] = useState([]);
      const [open, setOpen] = useState(false);
      const debounced = useDebouncedValue(query, 300);
      const ref = useRef(null);
      useEffect(()=>{
        if(!debounced || debounced.length<2){ setList([]); return; }
        const c = new AbortController();
        fetch(\`https://geo.api.gouv.fr/communes?nom=\${encodeURIComponent(debounced)}&fields=nom,code,population&boost=population&limit=10\`, { signal:c.signal })
          .then(r=>r.json()).then(d=>{ setList(Array.isArray(d)?d:[]); setOpen(true);}).catch(()=>{});
        return ()=>c.abort();
      }, [debounced]);
      useEffect(()=>{ function onClick(e){ if(ref.current && !ref.current.contains(e.target)) setOpen(false);} document.addEventListener('click', onClick); return ()=>document.removeEventListener('click', onClick); }, []);
      return (
        <div className="relative" ref={ref}>
          <input className="input" placeholder="ex. Apt" value={query} onChange={(e)=>setQuery(e.target.value)} onFocus={()=>setOpen(true)} />
          {open && list.length>0 && (
            <div className="dropdown mt-1">
              {list.map(c => (
                <div key={c.code} className="dropdown-item" onClick={()=>{ setQuery(c.nom); setOpen(false); onSelect && onSelect(c); onPopulation && onPopulation(c.population||null); }}>
                  <div className="font-medium">{c.nom}</div>
                  <div className="text-xs muted">INSEE {c.code} • Pop. {c.population?.toLocaleString('fr-FR')||'?'}</div>
                </div>
              ))}
            </div>
          )}
        </div>
      );
    }

    function App(){
      // Core settings
      const [commune, setCommune] = useState({ nom:"", insee:"", population:null });
      const [population, setPopulation] = useState(null);
      // Benchmark national €/hab — par défaut 1 474 €/hab (INSEE 2023, total dépenses moyennes communes)
      const [eurosParHab, setEurosParHab] = useState(1474);
      // Impondérables (planchers) en % du total (éditables)
      const [floors, setFloors] = useState([
        { id:"personnel", label:"Personnel communal (masse salariale)", pct: 35 },
        { id:"voirie", label:"Voirie communale (entretien minimum)", pct: 8 },
        { id:"ecoles", label:"Écoles maternelles & élémentaires", pct: 7 },
        { id:"services", label:"Services obligatoires (état civil, police admin.)", pct: 5 },
        { id:"energie", label:"Énergie & bâtiments communaux", pct: 6 },
        { id:"dette", label:"Annuité de dette (intérêts + capital)", pct: 6 },
      ]);
      // Discrétionnaire: calculé comme le reste; on expose un min/max guardrails
      const totalPctFloors = useMemo(()=> floors.reduce((s,f)=> s + (Number(f.pct)||0), 0), [floors]);
      const popRef = useMemo(()=> population ?? commune.population ?? 0, [population, commune]);
      const totalIndicatif = useMemo(()=> (popRef || 0) * (Number(eurosParHab)||0), [popRef, eurosParHab]);
      const montantFloors = useMemo(()=> floors.map(f=> ({...f, amount: totalIndicatif * clamp((Number(f.pct)||0)/100, 0, 1)})), [floors, totalIndicatif]);
      const sommeFloors = useMemo(()=> montantFloors.reduce((s,f)=> s + f.amount, 0), [montantFloors]);
      const enveloppeLibre = useMemo(()=> Math.max(0, totalIndicatif - sommeFloors), [totalIndicatif, sommeFloors]);

      // Mesures libres
      const [items, setItems] = useState([
        { id:1, label:"Ex. rénovation équipements sportifs", montant: 150000 },
        { id:2, label:"Ex. plan ombrières d'écoles", montant: 80000 },
      ]);
      const totalProgramme = useMemo(()=> items.reduce((s,i)=> s + (Number(i.montant)||0), 0), [items]);
      const reliquat = useMemo(()=> Math.max(0, enveloppeLibre - totalProgramme), [enveloppeLibre, totalProgramme]);

      function updateFloor(id, pct){
        setFloors(prev => prev.map(f => f.id===id ? {...f, pct: Number(pct)} : f));
      }
      function addItem(){ const nid = (items.at(-1)?.id || 0) + 1; setItems(prev => [...prev, { id:nid, label:"Nouvelle mesure", montant: 0 }]); }
      function updateItem(id, key, value){ setItems(prev => prev.map(i => i.id===id ? {...i, [key]: key==='montant'? Number(value): value } : i)); }
      function removeItem(id){ setItems(prev => prev.filter(i => i.id!==id)); }

      function downloadJSON(){
        const payload = {
          commune: { nom: commune.nom, insee: commune.insee, population: popRef },
          hypotheses: {
            euros_par_habitant: Number(eurosParHab),
            floors_pct: floors.reduce((o,f)=> (o[f.id]=Number(f.pct), o), {}),
            total_pct_floors: totalPctFloors
          },
          calculs: {
            total_indicatif: totalIndicatif,
            floors: montantFloors.map(({id,label,pct,amount})=>({id,label,pct,amount})),
            enveloppe_libre: enveloppeLibre,
            programme: items,
            total_programme: totalProgramme,
            reliquat: reliquat
          }
        };
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type:"application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `simulation_budget_simple_${(commune.nom||"commune").replace(/\s+/g,"_")}.json`;
        document.body.appendChild(a); a.click(); a.remove();
        URL.revokeObjectURL(url);
      }

      function downloadPDF(){
        const el = document.getElementById('pdf-area');
        const opt = { margin: 8, filename: `Dossier_POP_BudgetSimple_${(commune.nom||"commune").replace(/\s+/g,"_")}.pdf`, image:{type:"jpeg",quality:0.98}, html2canvas:{scale:2,useCORS:true}, jsPDF:{unit:"mm",format:"a4",orientation:"portrait"} };
        html2pdf().set(opt).from(el).save();
      }

      // Seats for info only (unchanged rules)
      const seatRules = [
        { min: 0, max: 99, seats: 7 },
        { min: 100, max: 499, seats: 11 },
        { min: 500, max: 1499, seats: 15 },
        { min: 1500, max: 2499, seats: 19 },
        { min: 2500, max: 3499, seats: 23 },
        { min: 3500, max: 4999, seats: 27 },
        { min: 5000, max: 9999, seats: 29 },
        { min: 10000, max: 19999, seats: 33 },
        { min: 20000, max: 29999, seats: 35 },
        { min: 30000, max: 39999, seats: 39 },
        { min: 40000, max: 49999, seats: 43 },
        { min: 50000, max: 59999, seats: 45 },
        { min: 60000, max: 79999, seats: 49 },
        { min: 80000, max: 99999, seats: 53 },
        { min: 100000, max: 149999, seats: 55 },
        { min: 150000, max: 199999, seats: 59 },
        { min: 200000, max: 249999, seats: 61 },
        { min: 250000, max: 299999, seats: 65 },
        { min: 300000, max: Infinity, seats: 69 },
      ];
      function seatsFromPopulation(pop){ if(pop==null || isNaN(pop)) return null; const r=seatRules.find(r=>pop>=r.min && pop<=r.max); return r? r.seats:null; }
      const seats = useMemo(()=> seatsFromPopulation(popRef), [popRef]);

      return (
        <div className="space-y-6">
          <div className="flex items-center justify-between flex-wrap gap-3">
            <h1 className="text-2xl md:text-3xl font-bold">Budget communal — simulateur simple</h1>
            <div className="flex gap-2">
              <button className="btn bg-black text-white" onClick={downloadJSON}>Exporter JSON</button>
              <button className="btn bg-pink-600 text-white" onClick={downloadPDF}>Exporter PDF</button>
            </div>
          </div>

          <div id="pdf-area" className="space-y-6">
            <section className="card bg-white rounded-2xl p-6">
              <h2 className="text-xl font-semibold mb-4">1) Commune</h2>
              <div className="grid md:grid-cols-4 gap-4 items-start">
                <div className="md:col-span-2">
                  <label className="block text-sm mb-1">Nom de la commune (auto-complétion)</label>
                  <CommuneAutocomplete value={commune.nom} onSelect={(c)=>{ setCommune({ nom:c.nom, insee:c.code, population:c.population||null }); setPopulation(c.population||null); }} onPopulation={(p)=>setPopulation(p)} />
                </div>
                <div>
                  <label className="block text-sm mb-1">Population (éditable)</label>
                  <input type="number" className="input" value={popRef||""} onChange={(e)=>setPopulation(e.target.value?Number(e.target.value):null)} min={0} />
                </div>
                <div className="bg-gray-100 rounded-xl p-3 text-center">
                  <div className="text-xs uppercase muted">Sièges estimés</div>
                  <div className="text-2xl font-bold">{seats ?? "—"}</div>
                  <div className="text-xs muted">estimation par tranches (CGCT)</div>
                </div>
              </div>
              <div className="mt-2 text-xs muted">Hypothèse moyenne nationale : <strong>1 474 €/hab</strong> (INSEE 2023, dépenses totales des communes). Ajustable ci-dessous.</div>
            </section>

            <section className="card bg-white rounded-2xl p-6">
              <h2 className="text-xl font-semibold mb-4">2) Hypothèses & impondérables</h2>
              <div className="grid md:grid-cols-3 gap-4">
                <div>
                  <label className="block text-sm mb-1">Benchmark national (€/hab)</label>
                  <input type="number" className="input" value={eurosParHab} onChange={(e)=>setEurosParHab(Number(e.target.value))} min={0} step="10" />
                  <p className="text-xs muted mt-1">Source indic. INSEE (2023). Adaptez selon le profil territorial si besoin.</p>
                </div>
                <div className="bg-gray-50 rounded-xl p-3 text-center">
                  <div className="text-xs muted mb-1">Budget indicatif total</div>
                  <div className="text-2xl font-bold">{euro(totalIndicatif)}</div>
                  <div className="text-xs muted">= population × €/hab</div>
                </div>
                <div className="bg-gray-50 rounded-xl p-3 text-center">
                  <div className="text-xs muted mb-1">% impondérables (somme)</div>
                  <div className={"text-2xl font-bold " + (totalPctFloors>95? "text-red-600": "")}>{totalPctFloors.toFixed(0)}%</div>
                  <div className="text-xs muted">évitez de dépasser ~80–90%</div>
                </div>
              </div>

              <div className="mt-4 grid md:grid-cols-3 gap-3">
                {floors.map(f => (
                  <div key={f.id} className="bg-gray-50 rounded-xl p-3">
                    <div className="flex items-center justify-between">
                      <div className="font-medium">{f.label}</div>
                      <div className="text-sm">{f.pct}%</div>
                    </div>
                    <input type="range" min="0" max="100" value={f.pct} onChange={(e)=>updateFloor(f.id, e.target.value)} className="w-full my-2" />
                    <div className="text-sm muted">Montant plancher : <strong>{euro(totalIndicatif * (f.pct/100))}</strong></div>
                  </div>
                ))}
              </div>

              <div className="mt-4 grid md:grid-cols-3 gap-4 text-center">
                <div className="bg-gray-100 rounded-xl p-3">
                  <div className="text-xs muted">Somme impondérables</div>
                  <div className="text-lg font-semibold">{euro(sommeFloors)}</div>
                </div>
                <div className="bg-gray-100 rounded-xl p-3">
                  <div className="text-xs muted">Enveloppe libre</div>
                  <div className={"text-lg font-semibold " + (enveloppeLibre<=0 ? "text-red-600" : "")}>{euro(enveloppeLibre)}</div>
                </div>
                <div className="bg-gray-100 rounded-xl p-3">
                  <div className="text-xs muted">Reste après programme</div>
                  <div className={"text-lg font-semibold " + (reliquat<=0 ? "text-red-600" : "")}>{euro(reliquat)}</div>
                </div>
              </div>
              <p className="mt-2 text-[11px] muted">NB : les collèges relèvent des départements (pas de la commune). Les écoles maternelles/élémentaires relèvent des communes.</p>
            </section>

            <section className="card bg-white rounded-2xl p-6">
              <h2 className="text-xl font-semibold mb-4">3) Programme — à répartir sur l’enveloppe libre</h2>
              <div className="space-y-3">
                {items.map(i => (
                  <div key={i.id} className="border rounded-2xl p-3 flex flex-col md:flex-row gap-3 md:items-center">
                    <input className="input md:flex-1" value={i.label} onChange={(e)=>updateItem(i.id, 'label', e.target.value)} />
                    <input type="number" className="input md:w-56" value={i.montant} onChange={(e)=>updateItem(i.id, 'montant', e.target.value)} min="0" step="1000" />
                    <button className="btn bg-gray-200" onClick={()=>removeItem(i.id)}>Supprimer</button>
                  </div>
                ))}
                <button className="btn bg-black text-white" onClick={addItem}>+ Ajouter une mesure</button>
              </div>

              <div className="mt-4 grid md:grid-cols-3 gap-4 text-center">
                <div className="bg-gray-100 rounded-xl p-3">
                  <div className="text-xs muted">Total programme</div>
                  <div className="text-lg font-semibold">{euro(totalProgramme)}</div>
                </div>
                <div className="bg-gray-100 rounded-xl p-3">
                  <div className="text-xs muted">Enveloppe libre</div>
                  <div className="text-lg font-semibold">{euro(enveloppeLibre)}</div>
                </div>
                <div className="bg-gray-100 rounded-xl p-3">
                  <div className="text-xs muted">Reste après programme</div>
                  <div className={"text-lg font-semibold " + (reliquat<0 ? "text-red-600": "")}>{euro(reliquat)}</div>
                </div>
              </div>
            </section>

            <section className="text-center text-xs muted">© POP — Prototype statique. Valeurs indicatives. Hypothèse nationale par habitant modifiable. Ajustez les planchers selon votre commune.</section>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
